const end=document.querySelector('.end'),cog=document.querySelector('.cog'),deck=document.querySelector('.board'),start=document.querySelector('#start'),rows=document.querySelectorAll('.row'),close=document.querySelectorAll('.off'),back=document.querySelector('.deck-back'),cards=document.querySelectorAll('.row img'),factions=document.querySelector('.faction'),moves=document.querySelector('.count span'),settings=document.querySelector('.settings'),facBtn=document.querySelector('.panel-deck'),lives=document.querySelectorAll('.gems img'),dropdown=document.querySelector('.dropdown'),dpArrow=document.querySelector('#arrow-icon'),shuffleBtn=document.querySelector('#shuffle'),endMsg=document.querySelector('#end-message'),dpOptions=document.querySelectorAll('.option'),preview=document.querySelector('#preview img'),dpMenu=document.querySelector('.dropdown-menu'),timeScore=document.querySelector('#total-time'),movesScore=document.querySelector('#total-moves'),livesScore=document.querySelector('#remaining-lives');let faction,game,started,count,focused,next,one,two,match;const modal={open:e=>{e.style.display='flex';endMsg.textContent=game?'You win!':'You lose!';if(moves.textContent){clearInterval(started);timeScore.textContent=(!userSettings.gameplay.checked)?Math.abs(moves.textContent-45):'Disabled';movesScore.textContent=count;livesScore.innerHTML=game?document.querySelector('.gems').outerHTML:0}
if(!userSettings.sound.checked){audio.open.currentTime=0;audio.open.play()}},close:e=>{e.style.display='none';if(faction)back.src=preview.src;game=!0;if(game)shuffle();cards[0].focus();if(!userSettings.sound.checked){audio.close.currentTime=0;audio.close.play()}}};const userSettings={sound:document.querySelector('#disabled'),gameplay:document.querySelector('#moves'),difficulty:document.querySelector('#regular'),form:document.querySelector('#user-settings'),controls:document.querySelector('#controls')};const audio={open:document.querySelector('audio[data-audio="open"]'),close:document.querySelector('audio[data-audio="close"]'),flip:document.querySelector('audio[data-audio="flip"]')};const toggleMenu=e=>{if(dpMenu.classList.contains('open')){dpMenu.classList.remove('open');dpMenu.classList.add('close');dpArrow.style.transform='rotateX(180deg)'}else if(dpMenu.classList.contains('close')){dpMenu.classList.remove('close');dpMenu.classList.add('open');dpArrow.style.transform='rotateX(0deg)'}};const toggleControls=e=>{if(userSettings.form.style.display==='block'){userSettings.form.style.display='none';userSettings.controls.style.display='flex'}else if(userSettings.form.style.display!=='block'){userSettings.controls.style.display='none';userSettings.form.style.display='block'}}
const getFaction=e=>{if(e.target.classList.contains('option'))faction=e.target.dataset.faction;preview.src=`img/back_cards/${faction}_back.png`}
const toggleFocus=_=>{focused=!0;cards.forEach((e,i,a)=>a[i].tabIndex=i+1)}
const shuffle=_=>{clearInterval(started);moves.textContent=count=one=two=match=0;if(!focused)toggleFocus();if(!userSettings.gameplay.checked){moves.textContent=45;started=setInterval(timer,1000)}
for(let i=0;i<3;i++)lives[i].src='img/board/ruby.png';let order=[...Array(16)].map((e,i)=>i>7?i=i-7:i+1),card,index;for(card of cards){index=order[~~(Math.random()*order.length)];card.dataset.value=index;card.src=`img/back_cards/${faction}_back.png`;card.alt=`card number ${index}. Position (x:${(card.tabIndex > 4 ? card.tabIndex - 4 : card.tabIndex)}, y:${card.tabIndex > 12 ? 4 : (card.tabIndex > 8 ? 3 : (card.tabIndex > 4 ? 2 : 1))})`;card.classList.add('card');card.classList.remove('open','hold');order.splice(order.indexOf(index),1)}};const shortcuts=e=>{console.log(e.code);switch(e.code){case 'Escape':if(end.style.display==='flex'){modal.close(end)}else if(settings.style.display==='flex'){modal.close(settings)}else if((end.style.display==='none'||end.style.display==='')||(factions.style.display==='none'||factions.style.display==='')||(settings.style.display==='none'||settings.style.display==='')){modal.open(settings)}
break;case 'ArrowRight':if(e.target.classList.contains('card')){next=cards[[...cards].indexOf(e.target)+1];next?next.focus():cards[0].focus()}
break;case 'ArrowLeft':if(e.target.classList.contains('card')){next=cards[[...cards].indexOf(e.target)-1];next?next.focus():cards[cards.length-1].focus()}
break;case 'ArrowDown':if(e.target.classList.contains('card')){next=cards[[...cards].indexOf(e.target)+4];next?next.focus():cards[[...cards].indexOf(e.target)%4].focus()}
break;case 'ArrowUp':if(e.target.classList.contains('card')){next=cards[[...cards].indexOf(e.target)-4];next?next.focus():cards[[...cards].indexOf(e.target)+12].focus()}
break;case 'Space':case 'Enter':if(e.target.classList.contains('card')&&e.target==document.activeElement){flip(e)}else if(e.target.querySelector('input')){e.target.querySelector('input').checked=!0}else if(document.querySelector('.select')==document.activeElement){dpMenu.classList.remove('close');dpMenu.classList.add('open')}else if(document.activeElement.classList.contains('option')){getFaction(e);dpMenu.classList.remove('open');dpMenu.classList.add('close')}else if(faction&&e.target==start){modal.close(factions)}else if(e.target==shuffleBtn){shuffle()}else if(e.target==facBtn){modal.open(factions)}
break;case 'KeyS':shuffle();break;case 'KeyF':modal.open(factions);break}};const flip=e=>{let card=e.target.classList.contains('card')?e.target:null;if(card&&!card.classList.contains('open')){card.classList.add('open','hold');if(userSettings.difficulty.checked)card.src=`img/faction_cards/${faction}/card${card.dataset.value}.png`;one?two?0:two=card:one=card;(one&&two)?compare(one,two):0;if(!userSettings.sound.checked){audio.flip.currentTime=0;audio.flip.play()}}};const rate=_=>{let count=+moves.textContent;if((userSettings.gameplay.checked&&count==24)||(!userSettings.gameplay.checked&&count==0)){lives[0].src=''
console.log(count);game=!1;modal.open(end)}else if((userSettings.gameplay.checked&&count==18)||(!userSettings.gameplay.checked&&count==12)){lives[1].src='';console.log(count)}else if((userSettings.gameplay.checked&&count==12)||(!userSettings.gameplay.checked&&count==25)){lives[2].src='';console.log(count)}};const timer=_=>{console.log(--moves.textContent);rate();if(!+moves.textContent){clearInterval(started);game=!1;modal.open(end)}}
const compare=(a,b)=>{deck.removeEventListener('mousedown',flip);deck.removeEventListener('touchstart',flip);document.removeEventListener('keydown',shortcuts);count++;if(userSettings.gameplay.checked)moves.textContent=count;rate();one=two=0;if(!userSettings.difficulty.checked){a.src=`img/faction_cards/${faction}/card${a.dataset.value}.png`;b.src=`img/faction_cards/${faction}/card${b.dataset.value}.png`}
setTimeout(_=>{if(a.dataset.value==b.dataset.value){if(++match==8)modal.open(end)}else{a.src=`img/back_cards/${faction}_back.png`;b.src=`img/back_cards/${faction}_back.png`;a.classList.remove('open','hold');b.classList.remove('open','hold')}
setTimeout(_=>{deck.addEventListener('mousedown',flip);deck.addEventListener('touchstart',flip);document.addEventListener('keydown',shortcuts)},0)},750)};dropdown.addEventListener('mousedown',toggleMenu);dpMenu.addEventListener('mousedown',getFaction);start.addEventListener('mousedown',_=>faction?modal.close(factions):0);deck.addEventListener('mousedown',flip);shuffleBtn.addEventListener('mousedown',shuffle);facBtn.addEventListener('mousedown',_=>modal.open(factions));cog.addEventListener('mousedown',_=>modal.open(settings));close[0].addEventListener('mousedown',_=>modal.close(end));document.addEventListener('keydown',shortcuts);document.addEventListener('mousedown',e=>{e.target.classList=='settings'?modal.close(settings):e.target.classList=='end'?modal.close(end):0});document.querySelector('#slide').addEventListener('mousedown',toggleControls);dropdown.addEventListener('touchstart',e=>{e.preventDefault();toggleMenu()});dpMenu.addEventListener('touchstart',e=>{e.preventDefault();getFaction(e)});start.addEventListener('touchstart',e=>{e.preventDefault();faction?modal.close(factions):0});deck.addEventListener('touchstart',flip);shuffleBtn.addEventListener('touchstart',shuffle);facBtn.addEventListener('touchstart',e=>{e.preventDefault();modal.open(factions)});cog.addEventListener('touchstart',e=>{e.preventDefault();modal.open(settings)});close[0].addEventListener('touchstart',e=>{e.preventDefault();modal.close(end)});document.addEventListener('touchstart',e=>{e.preventDefault();e.target.classList=='settings'?modal.close(settings):e.target.classList=='end'?modal.close(end):0})